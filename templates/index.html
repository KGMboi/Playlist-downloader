<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Downloader</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .playlist { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        img { max-width: 100px; display: block; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Spotify Playlist Downloader</h1>
    <a href="/login"><button>Login with Spotify</button></a>
    <button onclick="searchUser()">Fetch My Playlists</button>
    <div id="playlists"></div>

    <script>
        async function searchUser() {
            const response = await fetch(`/api/search_user`);
            const data = await response.json();

            const playlistsDiv = document.getElementById("playlists");
            playlistsDiv.innerHTML = "";

            if (data.error) {
                playlistsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
                return;
            }

            data.playlists.forEach(playlist => {
                const div = document.createElement("div");
                div.className = "playlist";
                div.innerHTML = `
                    <h2>${playlist.name}</h2>
                    ${playlist.image ? `<img src="${playlist.image}" alt="${playlist.name}">` : ""}
                    <button onclick="downloadPlaylist('${playlist.url}')">Download</button>
                `;
                playlistsDiv.appendChild(div);
            });
        }

        async function downloadPlaylist(playlistUrl) {
            const response = await fetch(`/api/download`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url: playlistUrl })
            });

            const blob = await response.blob();
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "playlist.zip";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
